#!/bin/sh

if [ $# -gt 0 ] ; then
    LOG_PATH=$1
    TIMESTAMP=`basename $LOG_PATH`
    TIMESTAMP=`echo ${TIMESTAMP:0:11}`
else
    LOG_PATH=`pwd`
    TIMESTAMP=`date +%Y_%b_%d`
fi

LOG_NAME="benchmark_result_log"
LOG_RES=0

cd $LOG_PATH

/opt/uClinux/bfin-uclinux/bin/bfin-uclinux-gcc -v 2> $LOG_NAME
echo -e "\n\n" >> $LOG_NAME

TESTCASE="whetstone"
if [ -e build_${TESTCASE}_kernel_log ]; then
    if [ `grep -c "Copy linux" ./build_${TESTCASE}_kernel_log` == 1 ]; then
        if [ `grep -c "WHETSTONE TEST ............\[PASS\]" ./${TESTCASE}_test_log` == 1 ]; then
            echo "Test result of $TESTCASE" >> $LOG_NAME
            echo "##############################" >> $LOG_NAME
            sed -n '/Loop/,/Whetstones/p' ${TESTCASE}_test_log >> $LOG_NAME
            data=`grep Whetstones ${TESTCASE}_test_log | tr -d "[a-zA-Z :]"`
            echo -e "$TIMESTAMP\t$data" >> ../../${TESTCASE}_data
            cd ../..
            gnuplot ${TESTCASE}.plt
            cd $LOG_PATH
            let "LOG_RES+=1"
        else
            echo "##################" >> $LOG_NAME
            echo "${TESTCASE} fail!" >> $LOG_NAME
            echo "##################" >> $LOG_NAME
        fi
    else
        echo "##############################" >> $LOG_NAME
        echo "Build test case ${TESTCASE} fail!" >> $LOG_NAME
        echo "##############################" >> $LOG_NAME
    fi
else
    echo "#########################################" >> $LOG_NAME
    echo "No such file: build_${TESTCASE}_kernel_log!" >> $LOG_NAME
    echo "#########################################" >> $LOG_NAME
fi
echo -e "\n\n" >> $LOG_NAME

TESTCASE="dhrystone"
if [ -e build_${TESTCASE}_kernel_log ]; then
    if [ `grep -c "Copy linux" ./build_${TESTCASE}_kernel_log` == 1 ]; then
        if [ `grep -c "DHRYSTONE TEST ............\[PASS\]" ./${TESTCASE}_test_log` == 1 ]; then
            echo "Test result of $TESTCASE" >> $LOG_NAME
            echo "##############################" >> $LOG_NAME
            sed -n '/Benchmark/,/Dhrystones per Second/p' ${TESTCASE}_test_log >> $LOG_NAME
            data=`grep ".Dhrystones" ${TESTCASE}_test_log | awk '{print $3 "\t" $8}'`
            echo -e "$TIMESTAMP\t$data" >> ../../${TESTCASE}_data
            cd ../..
            gnuplot ${TESTCASE}.plt
            cd $LOG_PATH
            let "LOG_RES+=1"
        else
            echo "##################" >> $LOG_NAME
            echo "${TESTCASE} fail!" >> $LOG_NAME
            echo "##################" >> $LOG_NAME
        fi
    else
        echo "##############################" >> $LOG_NAME
        echo "Build test case ${TESTCASE} fail!" >> $LOG_NAME
        echo "##############################" >> $LOG_NAME
    fi
else
    echo "#########################################" >> $LOG_NAME
    echo "No such file: build_${TESTCASE}_kernel_log!" >> $LOG_NAME
    echo "#########################################" >> $LOG_NAME
fi
echo -e "\n\n" >> $LOG_NAME

TESTCASE="nbench"
if [ -e build_${TESTCASE}_kernel_log ]; then
    if [ `grep -c "Copy linux" ./build_${TESTCASE}_kernel_log` == 1 ]; then
        if [ `grep -c "NBENCH TEST ............\[PASS\]" ./${TESTCASE}_test_log` == 1 ]; then
            echo "Results of $TESTCASE" >> $LOG_NAME
            echo "##############################" >> $LOG_NAME
            sed -n '/Benchmark/,/Trademarks/p' ${TESTCASE}_test_log >> $LOG_NAME
            data=`grep "NUMERIC" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`
            data="$data\t`grep "STRING" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "BITFIELD" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "FP" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "FOURIER" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "ASSIGNMENT" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "IDEA" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "HUFFMAN" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "NEURAL" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            data="$data\t`grep "LU" ${TESTCASE}_test_log | awk -F : '{print $2}' | tr -d " "`"
            echo -e "$TIMESTAMP\t$data" >> ../../${TESTCASE}_data
            cd ../..
            gnuplot ${TESTCASE}.plt
            cd $LOG_PATH
            let "LOG_RES+=1"
        else
            echo "##################" >> $LOG_NAME
            echo "${TESTCASE} fail!" >> $LOG_NAME
            echo "##################" >> $LOG_NAME
        fi
    else
        echo "##############################" >> $LOG_NAME
        echo "Build test case ${TESTCASE} fail!" >> $LOG_NAME
        echo "##############################" >> $LOG_NAME
    fi
else
    echo "#########################################" >> $LOG_NAME
    echo "No such file: build_${TESTCASE}_kernel_log!" >> $LOG_NAME
    echo "#########################################" >> $LOG_NAME
fi
echo -e "\n\n" >> $LOG_NAME

TESTCASE="edn"
if [ -e build_${TESTCASE}_kernel_log ]; then
    if [ `grep -c "Copy linux" ./build_${TESTCASE}_kernel_log` == 1 ]; then
        if [ `grep -c "EDN TEST ............\[PASS\]" ./${TESTCASE}_test_log` == 1 ]; then
            dos2unix ${TESTCASE}_test_log
            echo "Results of $TESTCASE" >> $LOG_NAME
            echo "##############################" >> $LOG_NAME
            sed -n '/System used/,/jpegdct/p' ${TESTCASE}_test_log >> $LOG_NAME
            data=`grep "overhead" ${TESTCASE}_test_log | awk '{print $2}'`
            data="$data\t`grep "vec_mpy1" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "^mac" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "\<fir\>" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "fir_no_red_ld" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "latsynth" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "iir1" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "codebook" ${TESTCASE}_test_log | awk '{print $2}'`"
            data="$data\t`grep "jpegdct" ${TESTCASE}_test_log | awk '{print $2}'`"
            echo -e "$TIMESTAMP\t$data" >> ../../${TESTCASE}_data
            cd ../..
            gnuplot ${TESTCASE}.plt
            cd $LOG_PATH
            let "LOG_RES+=1"
        else
            echo "##################" >> $LOG_NAME
            echo "${TESTCASE} fail!" >> $LOG_NAME
            echo "##################" >> $LOG_NAME
        fi
    else
        echo "##############################" >> $LOG_NAME
        echo "Build test case ${TESTCASE} fail!" >> $LOG_NAME
        echo "##############################" >> $LOG_NAME
    fi
else
    echo "#########################################" >> $LOG_NAME
    echo "No such file: build_${TESTCASE}_kernel_log!" >> $LOG_NAME
    echo "#########################################" >> $LOG_NAME
fi
echo -e "\n\n" >> $LOG_NAME


TESTCASE="lmbench"
if [ -e build_${TESTCASE}_kernel_log ]; then
    if [ `grep -c "Copy linux" ./build_${TESTCASE}_kernel_log` == 1 ]; then
        if [ `grep -c "LMBENCH TEST ............\[PASS\]" ./${TESTCASE}_test_log` == 1 ]; then
            dos2unix ${TESTCASE}_test_log
            echo "Results of $TESTCASE (run lat_ctx)" >> $LOG_NAME
            echo "##############################" >> $LOG_NAME
            sed -n '/lat_ctx/,/LMBENCH TEST/p' ${TESTCASE}_test_log |grep -v PASS|grep -v lat_ctx|grep -v root >> $LOG_NAME
            data_size0="$TIMESTAMP `grep -A 3 "size=0" ${TESTCASE}_test_log | grep -v "=" | awk '{print $2}'`"
            data_size16="$TIMESTAMP `grep -A 3 "size=16" ${TESTCASE}_test_log | grep -v "=" | awk '{print $2}'`"
            data_size64="$TIMESTAMP `grep -A 3 "size=64" ${TESTCASE}_test_log | grep -v "=" | awk '{print $2}'`"
            echo $data_size0 | tr " " "\t" >> ../../${TESTCASE}_data_size0
            echo $data_size16 | tr " " "\t" >> ../../${TESTCASE}_data_size16
            echo $data_size64 | tr " " "\t" >> ../../${TESTCASE}_data_size64
            cd ../..
            gnuplot ${TESTCASE}.plt
            cd $LOG_PATH
            let "LOG_RES+=1"
        else
            echo "##################" >> $LOG_NAME
            echo "${TESTCASE} fail!" >> $LOG_NAME
            echo "##################" >> $LOG_NAME
        fi
    else
        echo "##############################" >> $LOG_NAME
        echo "Build test case ${TESTCASE} fail!" >> $LOG_NAME
        echo "##############################" >> $LOG_NAME
    fi
else
    echo "#########################################" >> $LOG_NAME
    echo "No such file: build_${TESTCASE}_kernel_log!" >> $LOG_NAME
    echo "#########################################" >> $LOG_NAME
fi


dos2unix $LOG_NAME

exit $LOG_RES
